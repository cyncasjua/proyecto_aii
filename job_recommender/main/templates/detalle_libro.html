{% extends "base.html" %}
{% block content %}
<section class="section">
    <div class="container">
        <div class="columns is-variable is-6 is-multiline" style="align-items: flex-start;">
            <div class="column is-12-mobile is-4-tablet is-3-desktop" style="min-width:220px;">
                <figure class="image is-3by4" style="background: #fff; border: 1px solid #eee; padding: 1rem; min-height: 420px; display: flex; align-items: center; justify-content: center; position:relative; border-radius: 12px;">
                    <img src="{{ libro.imagen_url }}" alt="{{ libro.titulo }}" style="object-fit: contain; width: 100%; max-height: 400px; border-radius: 8px;">
                    <button id="fav-btn" class="button is-small" style="position:absolute; top:10px; right:10px; background:#fff; border:1.5px solid #7c3aed; color:#7c3aed; border-radius:50%; width:2.2em; height:2.2em; display:flex; align-items:center; justify-content:center; font-size:1.3em; box-shadow:0 2px 8px #7c3aed22;" onclick="toggleFavorito(event)">
                        <span id="fav-icon">&#9734;</span>
                    </button>
                    <button id="quiero-leer-btn" class="button is-small" style="position:absolute; top:50px; right:10px; background:#fff; border:1.5px solid #00b894; color:#00b894; border-radius:50%; width:2.2em; height:2.2em; display:flex; align-items:center; justify-content:center; font-size:1.1em; box-shadow:0 2px 8px #00b89422;" onclick="toggleQuieroLeer(event)">
                        <span id="quiero-leer-icon">&#128214;</span>
                    </button>
                    <button id="leido-btn" class="button is-small" style="position:absolute; top:90px; right:10px; background:#fff; border:1.5px solid #0984e3; color:#0984e3; border-radius:50%; width:2.2em; height:2.2em; display:flex; align-items:center; justify-content:center; font-size:1.1em; box-shadow:0 2px 8px #0984e322;" onclick="toggleLeido(event)">
                        <span id="leido-icon">&#10003;</span>
                    </button>
                </figure>
            </div>
            <div class="column is-12-mobile is-8-tablet is-9-desktop" style="min-width:260px;">
                <h1 class="title is-2" style="color:#7c3aed; font-weight:800;">{{ libro.titulo }}</h1>
                <p class="subtitle is-5 mb-2"><strong>Categoría:</strong> <span style="color:#7c3aed;">{{ libro.categoria }}</span></p>
                <p class="mb-1"><strong>Precio:</strong> <span style=" font-weight:600;">{{ libro.precio }}</span></p>
                <p class="mb-1"><strong>Rating:</strong> 
                    <span>
                        {% if libro.rating|lower == "one" %}
                            {% with rating_num=1 rating_color="#e74c3c" %}
                                {% for i in "12345" %}
                                    {% if forloop.counter <= rating_num %}
                                        <span style="color:{{ rating_color }};">&#9733;</span>
                                    {% else %}
                                        <span style="color:#ddd;">&#9733;</span>
                                    {% endif %}
                                {% endfor %}
                            {% endwith %}
                        {% elif libro.rating|lower == "two" %}
                            {% with rating_num=2 rating_color="#f39c12" %}
                                {% for i in "12345" %}
                                    {% if forloop.counter <= rating_num %}
                                        <span style="color:{{ rating_color }};">&#9733;</span>
                                    {% else %}
                                        <span style="color:#ddd;">&#9733;</span>
                                    {% endif %}
                                {% endfor %}
                            {% endwith %}
                        {% elif libro.rating|lower == "three" %}
                            {% with rating_num=3 rating_color="#f7b731" %}
                                {% for i in "12345" %}
                                    {% if forloop.counter <= rating_num %}
                                        <span style="color:{{ rating_color }};">&#9733;</span>
                                    {% else %}
                                        <span style="color:#ddd;">&#9733;</span>
                                    {% endif %}
                                {% endfor %}
                            {% endwith %}
                        {% elif libro.rating|lower == "four" %}
                            {% with rating_num=4 rating_color="#6fcf97" %}
                                {% for i in "12345" %}
                                    {% if forloop.counter <= rating_num %}
                                        <span style="color:{{ rating_color }};">&#9733;</span>
                                    {% else %}
                                        <span style="color:#ddd;">&#9733;</span>
                                    {% endif %}
                                {% endfor %}
                            {% endwith %}
                        {% elif libro.rating|lower == "five" %}
                            {% with rating_num=5 rating_color="#27ae60" %}
                                {% for i in "12345" %}
                                    {% if forloop.counter <= rating_num %}
                                        <span style="color:{{ rating_color }};">&#9733;</span>
                                    {% else %}
                                        <span style="color:#ddd;">&#9733;</span>
                                    {% endif %}
                                {% endfor %}
                            {% endwith %}
                        {% else %}
                            {% with rating_num=0 %}
                                {% for i in "12345" %}
                                    <span style="color:#ddd;">&#9733;</span>
                                {% endfor %}
                            {% endwith %}
                        {% endif %}
                    </span>
                </p>
                <div class="content mt-4" style="font-size:1.15em; color:#444;">{{ libro.descripcion }}</div>
            </div>
        </div>
        <h2 class="title is-5 mt-6" style="color:#7c3aed;">Puntúa este libro</h2>
        <form method="post" action="">
            {% csrf_token %}
            <div class="field has-addons" style="align-items: center;">
                <div class="control">
                    <div style="display: flex; gap: 0.2em; font-size: 2em;">
                        {% for i in "12345" %}
                            <label style="cursor:pointer;">
                                <input type="radio" name="puntuacion" value="{{ i }}" style="display:none;" {% if puntuacion_usuario|stringformat:'i' == i %}checked{% endif %} onchange="this.form.submit()">
                                {% if puntuacion_usuario|stringformat:'i' >= i %}
                                    <span style="color:#FFD700">&#9733;</span>
                                {% else %}
                                    <span style="color:#ccc">&#9733;</span>
                                {% endif %}
                            </label>
                        {% endfor %}
                    </div>
                </div>
                {% if puntuacion_usuario %}
                <div class="control">
                    <span class="ml-2">Tu puntuación: <span style="color:#7c3aed; font-weight:bold;">{{ puntuacion_usuario }} / 5</span></span>
                </div>
                {% endif %}
            </div>
        </form>
        <h2 class="title is-4 mt-6">Libros similares</h2>
        <div class="columns is-multiline" style="flex-wrap: wrap;">
            {% for rec in recomendaciones %}
            <div class="column is-6-mobile is-4-tablet is-one-fifth-desktop" style="min-width:170px; max-width:220px;">
                <a href="{% url 'detalle_libro' rec.id %}" style="text-decoration: none; color: inherit;">
                    <div class="card" style="height: 100%; min-height: 220px; display: flex; flex-direction: column; align-items: center; box-shadow:0 2px 8px #7c3aed22; border-radius:12px;">
                        <div class="card-image" style="margin-top: 1rem;">
                            <figure class="image is-4by5" style="height: 140px; width: 100px; display: flex; align-items: center; justify-content: center; background: #fff; border: 1px solid #eee; border-radius:8px;">
                                <img src="{{ rec.imagen_url }}" alt="{{ rec.titulo }}" style="object-fit: contain; width: 100%; height: 100%; border-radius:6px;">
                            </figure>
                        </div>
                        <div class="card-content" style="text-align: center; padding: 0.5rem; min-height: 60px;">
                            <p class="is-size-6" style="color:#7c3aed; font-weight:600;">{{ rec.titulo }}</p>
                        </div>
                    </div>
                </a>
            </div>
            {% empty %}
            <div class="column">
                <p class="has-text-grey-light" style="font-style:italic;">No hay recomendaciones.</p>
            </div>
            {% endfor %}
        </div>
        <hr class="mt-6 mb-5">
        <h2 class="title is-5 mt-6" style="color:#7c3aed;">Opiniones de usuarios</h2>
        <div class="box" style="background:#f8f7fc; border-radius: 16px; box-shadow:0 2px 16px #7c3aed22;">
            {% if opiniones %}
                {% for op in opiniones %}
                    <article class="media mb-3" style="border-bottom:1px solid #ececec; padding-bottom:0.7em;">
                        <div class="media-content">
                            <div class="content">
                                <strong style="color:#7c3aed;">{{ op.usuario.username }}</strong>
                                <span class="is-size-7 has-text-grey">{{ op.fecha|date:"d/m/Y H:i" }}</span>
                                <p style="margin-top:0.2em;">{{ op.texto }}</p>
                            </div>
                        </div>
                    </article>
                {% endfor %}
            {% else %}
                <p class="has-text-grey">Aún no hay opiniones para este libro.</p>
            {% endif %}
        </div>
        <form method="post" action="" class="mt-4">
            {% csrf_token %}
            <div class="field">
                <label class="label">Deja tu opinión</label>
                <div class="control">
                    <textarea name="opinion" class="textarea" placeholder="Escribe aquí tu opinión..." required style="border-radius:8px;"></textarea>
                </div>
            </div>
            <div class="field">
                <div class="control">
                    <button type="submit" class="button purple is-circular">Enviar opinión</button>
                </div>
            </div>
        </form>
        <div class="has-text-centered mt-6">
            <a href="{% url 'listado_libros' %}" class="button purple is-circular">&larr; Volver al listado</a>
        </div>
    </div>
</section>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

function toggleFavorito(e) {
    e.preventDefault();
    fetch("{% url 'toggle_favorito' libro.id %}", {
        method: "POST",
        headers: {"X-CSRFToken": csrftoken}
    })
    .then(r => r.json())
    .then(data => {
        document.getElementById('fav-icon').innerHTML = data.favorito ? '★' : '☆';
        document.getElementById('fav-btn').style.background = data.favorito ? '#7c3aed' : '#fff';
        document.getElementById('fav-btn').style.color = data.favorito ? '#fff' : '#7c3aed';
    });
}
function toggleQuieroLeer(e) {
    e.preventDefault();
    fetch("{% url 'toggle_quiero_leer' libro.id %}", {
        method: "POST",
        headers: {"X-CSRFToken": csrftoken}
    })
    .then(r => r.json())
    .then(data => {
        document.getElementById('quiero-leer-icon').style.color = data.quiero_leer ? '#fff' : '#00b894';
        document.getElementById('quiero-leer-btn').style.background = data.quiero_leer ? '#00b894' : '#fff';
        document.getElementById('quiero-leer-btn').style.color = data.quiero_leer ? '#fff' : '#00b894';
    });
}
function toggleLeido(e) {
    e.preventDefault();
    fetch("{% url 'toggle_leido' libro.id %}", {
        method: "POST",
        headers: {"X-CSRFToken": csrftoken}
    })
    .then(r => r.json())
    .then(data => {
        document.getElementById('leido-icon').style.color = data.leido ? '#fff' : '#0984e3';
        document.getElementById('leido-btn').style.background = data.leido ? '#0984e3' : '#fff';
        document.getElementById('leido-btn').style.color = data.leido ? '#fff' : '#0984e3';
    });
}
fetch("{% url 'toggle_favorito' libro.id %}", {method: "GET"})
    .then(r => r.json())
    .then(data => {
        document.getElementById('fav-icon').innerHTML = data.favorito ? '★' : '☆';
        document.getElementById('fav-btn').style.background = data.favorito ? '#7c3aed' : '#fff';
        document.getElementById('fav-btn').style.color = data.favorito ? '#fff' : '#7c3aed';
    });
fetch("{% url 'toggle_quiero_leer' libro.id %}", {method: "GET"})
    .then(r => r.json())
    .then(data => {
        document.getElementById('quiero-leer-icon').style.color = data.quiero_leer ? '#fff' : '#00b894';
        document.getElementById('quiero-leer-btn').style.background = data.quiero_leer ? '#00b894' : '#fff';
        document.getElementById('quiero-leer-btn').style.color = data.quiero_leer ? '#fff' : '#00b894';
    });
fetch("{% url 'toggle_leido' libro.id %}", {method: "GET"})
    .then(r => r.json())
    .then(data => {
        document.getElementById('leido-icon').style.color = data.leido ? '#fff' : '#0984e3';
        document.getElementById('leido-btn').style.background = data.leido ? '#0984e3' : '#fff';
        document.getElementById('leido-btn').style.color = data.leido ? '#fff' : '#0984e3';
    });
</script>
{% endblock %}